"use client";

import { useState } from "react";
import { Button } from "@/components/ui/Button";
import { Search } from "lucide-react";
import { Pagination } from "@/components/ui/Pagination";
import { SearchBar } from "@/components/ui/SearchBar";
import { Table } from "@/components/ui/Table";
import Image from "next/image";

export function ToursTable() {
  const tours: any[] = [];
    date: "25-01-15",
    time: "10:30 AM",
    property: {
      name: "Luxury Marian Apartment",
      location: "Dubai Marina , Dubai",
      image: "/jumeirah.png",
    },
    landlord: {
      name: "Rober Chen",
      email: "abc@gmail.com",
      phone: "023-3323442-4433",
      represent: true,
    },
    tenant: {
      name: "abc@gmail.com",
      email: "abc@gmail.com",
      phone: "023-3323442-4433",
    },
    status: { label: "Cancelled", color: "text-red-700 bg-red-100" },
    lockBox: { label: "In use", color: "text-blue-700 bg-blue-100" },
  },
  {
    date: "25-01-15",
    time: "10:30 AM",
    property: {
      name: "Luxury Marian Apartment",
      location: "Dubai Marina , Dubai",
      image: "/jumeirah.png",
    },
    landlord: {
      name: "Rober Chen",
      email: "abc@gmail.com",
      phone: "023-3323442-4433",
      represent: true,
    },
    tenant: {
      name: "abc@gmail.com",
      email: "abc@gmail.com",
      phone: "023-3323442-4433",
    },
    status: { label: "Completed", color: "text-purple-700 bg-purple-100" },
    lockBox: { label: "Available", color: "text-green-700 bg-green-100" },
  },
  {
    date: "25-01-15",
    time: "10:30 AM",
    property: {
      name: "Luxury Marian Apartment",
      location: "Dubai Marina , Dubai",
      image: "/jumeirah.png",
    },
    landlord: {
      name: "Rober Chen",
      email: "abc@gmail.com",
      phone: "023-3323442-4433",
      represent: true,
    },
    tenant: {
      name: "abc@gmail.com",
      email: "abc@gmail.com",
      phone: "023-3323442-4433",
    },
    status: { label: "Scheduled", color: "text-blue-700 bg-blue-100" },
    lockBox: { label: "Available", color: "text-green-700 bg-green-100" },
  },
];

export function ToursTable() {
  const [activeTab, setActiveTab] = useState("Past");
  const [search, setSearch] = useState("");
  const [status, setStatus] = useState("All Statuses");
  const [property, setProperty] = useState("All Properties");
  const [currentPage, setCurrentPage] = useState(1);
  const rowsPerPage = 8;
  // Helper to parse date/time string to JS Date
  function parseTourDateTime(date: string, time: string) {
    // date: "25-01-15", time: "10:30 AM"
    // Format: YY-MM-DD (assuming 20YY)
    const [yy, mm, dd] = date.split("-");
    const year = 2000 + parseInt(yy, 10);
    const month = parseInt(mm, 10) - 1;
    const day = parseInt(dd, 10);
    // time: "10:30 AM"
    const [hms, ampm] = time.split(" ");
    let [hour, minute] = hms.split(":").map(Number);
    if (ampm === "PM" && hour !== 12) hour += 12;
    if (ampm === "AM" && hour === 12) hour = 0;
    return new Date(year, month, day, hour, minute);
  }

  const now = new Date();
  let filteredTours = tours.filter(
    (tour) =>
      tour.property.name.toLowerCase().includes(search.toLowerCase()) ||
      tour.property.location.toLowerCase().includes(search.toLowerCase()) ||
      tour.tenant.name.toLowerCase().includes(search.toLowerCase()) ||
      tour.landlord.name.toLowerCase().includes(search.toLowerCase())
  );
  // Tab filter
  if (activeTab === "Upcoming") {
    filteredTours = filteredTours.filter(tour => parseTourDateTime(tour.date, tour.time) > now);
  } else if (activeTab === "Past") {
    filteredTours = filteredTours.filter(tour => parseTourDateTime(tour.date, tour.time) < now);
  }
  if (status !== "All Statuses") {
    filteredTours = filteredTours.filter(t => t.status.label === status);
  }
  if (property !== "All Properties") {
    filteredTours = filteredTours.filter(t => t.property.name === property);
  }
  const paginatedTours = filteredTours.slice(
    (currentPage - 1) * rowsPerPage,
    currentPage * rowsPerPage,
  );

  const columns = [
    {
      key: "dateTime",
      header: "Date & Time",
      render: (row: any) => (
        <div className="font-bold text-black text-sm">
          {row.date}
          <span className="px-2 text-xs text-gray-500 font-normal mt-1">
            {row.time}
          </span>
        </div>
      ),
      className: "px-6 py-4 whitespace-nowrap align-middle",
    },
    {
      key: "property",
      header: "Property",
      render: (row: any) => (
        <div className="flex items-center gap-2">
          <Image
            src={row.property.image}
            alt="property"
            width={40}
            height={40}
            className="rounded"
          />
          <div>
            <div className="font-semibold text-sm">{row.property.name}</div>
            <div className="text-xs text-gray-500">{row.property.location}</div>
          </div>
        </div>
      ),
      className: "px-6 py-4",
    },
    {
      key: "landlord",
      header: "Landlord",
      render: (row: any) => (
        <>
          <div className="font-semibold text-sm">{row.landlord.name}</div>
          <div className="text-xs text-[#018FBD] cursor-pointer">
            You represent this landlord
          </div>
        </>
      ),
      className: "px-6 py-4",
    },
    {
      key: "tenant",
      header: "Tenant(for coordination)",
      render: (row: any) => (
        <>
          <div className="font-semibold text-sm">{row.tenant.name}</div>
          <div className="text-xs text-[#CAB305]">{row.tenant.phone}</div>
        </>
      ),
      className: "px-6 py-4",
    },
    {
      key: "status",
      header: "Status",
      render: (row: any) => (
        <span
          className={`px-3 py-1 rounded-none font-semibold text-xs ${row.status.color}`}
        >
          {row.status.label}
        </span>
      ),
      className: "px-6 py-4",
    },
    {
      key: "lockBox",
      header: "Lock Box",
      render: (row: any) => (
        <span
          className={`px-3 py-1 rounded-none font-semibold text-xs ${row.lockBox.color}`}
        >
          {row.lockBox.label}
        </span>
      ),
      className: "px-6 py-4",
    },
  ];
  return (
    <div className="bg-card rounded-lg">
      <div className="bg-gray-50 rounded-lg">
        <div>
          <div className="flex items-center justify-between mb-8">
            <h1 className="text-2xl font-bold">Tours</h1>
            <div className="flex gap-6">
              <button
                className={`px-12 py-3 border rounded-none text-base font-medium transition-colors duration-100
                  border-[#008BBC] 
                  ${activeTab === "Upcoming" ? "bg-[#FBDE02] text-black" : "bg-white text-[#008BBC]"}
                `}
                onClick={() => setActiveTab("Upcoming")}
              >
                <span
                  className={
                    activeTab === "Upcoming" ? "font-bold" : "font-medium"
                  }
                >
                  Upcoming
                </span>
              </button>
              <button
                className={`px-12 py-3 border rounded-none text-base font-medium transition-colors duration-100
                  border-[#008BBC] 
                  ${activeTab === "Past" ? "bg-[#FBDE02] text-black" : "bg-white text-[#008BBC]"}
                `}
                onClick={() => setActiveTab("Past")}
              >
                <span
                  className={activeTab === "Past" ? "font-bold" : "font-medium"}
                >
                  Past
                </span>
              </button>
              <button
                className={`px-12 py-3 border rounded-none text-base font-medium transition-colors duration-100
                  border-[#008BBC] 
                  ${activeTab === "All" ? "bg-[#FBDE02] text-black" : "bg-white text-[#008BBC]"}
                `}
                onClick={() => setActiveTab("All")}
              >
                <span
                  className={activeTab === "All" ? "font-bold" : "font-medium"}
                >
                  All
                </span>
              </button>
            </div>
          </div>
          <div className="flex items-center mb-6">
            <SearchBar
              value={search}
              onChange={setSearch}
              placeholder="Search tenant, landlord and property"
            />
            <div className="flex items-center gap-4 ml-6 w-full justify-end">
              <select
                className="px-4 py-2 bg-gray-50 rounded-lg text-sm border border-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-200"
                value={status}
                onChange={(e) => setStatus(e.target.value)}
              >
                <option>All Statuses</option>
                <option>Confirmed</option>
                <option>Scheduled</option>
                <option>No-show</option>
                <option>Active</option>
                <option>Cancelled</option>
                <option>Completed</option>
              </select>
              <select
                className="px-4 py-2 bg-gray-50 rounded-lg text-sm border border-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-200"
                value={property}
                onChange={(e) => setProperty(e.target.value)}
              >
                <option>All Properties</option>
                {Array.from(new Set(tours.map((t) => t.property.name))).map(
                  (name) => (
                    <option key={name}>{name}</option>
                  ),
                )}
              </select>
            </div>
          </div>
        </div>
        <div className="bg-card rounded-lg p-6">
          <Table columns={columns} data={paginatedTours} />
          <div className="flex items-center justify-between p-6">
            <Pagination
              totalRows={tours.length}
              rowsPerPage={rowsPerPage}
              currentPage={currentPage}
              onPageChange={setCurrentPage}
            />
          </div>
        </div>
      </div>
    </div>
  );
}
